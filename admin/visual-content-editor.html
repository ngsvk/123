<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Content Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
  
  <!-- Authentication System -->
  <script src="static-auth.js"></script>
  <script src="auth-guard.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1B3764',
            secondary: '#DAA520'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto py-8 px-4">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Visual Content Editor</h1>
          <p class="text-gray-600">Edit website content with an intuitive interface</p>
        </div>
        <div class="flex space-x-3">
          <button onclick="loadContent()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            <i class="ri-refresh-line mr-2"></i>Load Content
          </button>
          <button onclick="saveContent()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            <i class="ri-save-line mr-2"></i>Save Changes
          </button>
          <button onclick="previewChanges()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
            <i class="ri-eye-line mr-2"></i>Preview
          </button>
        </div>
      </div>
    </div>

    <!-- Page Selector -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Select Content to Edit</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <button onclick="loadPageContent('homepage')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="homepage">
          <i class="ri-home-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">Homepage</div>
        </button>
        <button onclick="loadPageContent('about')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="about">
          <i class="ri-information-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">About</div>
        </button>
        <button onclick="loadPageContent('academics')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="academics">
          <i class="ri-book-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">Academics</div>
        </button>
        <button onclick="loadPageContent('admissions')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="admissions">
          <i class="ri-graduation-cap-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">Admissions</div>
        </button>
        <button onclick="loadPageContent('campus-life')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="campus-life">
          <i class="ri-building-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">Campus Life</div>
        </button>
        <button onclick="loadPageContent('gallery')" class="content-btn p-4 border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors" data-page="gallery">
          <i class="ri-gallery-line text-2xl text-primary mb-2"></i>
          <div class="text-sm font-medium">Gallery</div>
        </button>
      </div>
    </div>

    <!-- Content Editor -->
    <div id="content-editor" class="hidden">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">Editing: <span id="current-editing"></span></h2>
          <button onclick="showRawJSON()" class="text-gray-600 hover:text-gray-800">
            <i class="ri-code-line mr-1"></i>View Raw JSON
          </button>
        </div>

        <div id="editor-content">
          <!-- Dynamic content will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Raw JSON Editor Modal -->
    <div id="raw-json-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold">Raw JSON Editor</h3>
            <button onclick="closeRawJSON()" class="text-gray-400 hover:text-gray-600">
              <i class="ri-close-line text-xl"></i>
            </button>
          </div>
        </div>
        
        <div class="p-6">
          <textarea id="raw-json-editor" class="w-full h-96 p-4 border border-gray-300 rounded-lg font-mono text-sm" placeholder="JSON content will appear here..."></textarea>
        </div>
        
        <div class="border-t border-gray-200 p-6">
          <div class="flex justify-end space-x-4">
            <button onclick="validateJSON()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
              <i class="ri-check-line mr-2"></i>Validate JSON
            </button>
            <button onclick="applyRawJSON()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
              <i class="ri-save-line mr-2"></i>Apply Changes
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    let currentPage = null;
    let currentContent = null;

    function loadPageContent(page) {
      currentPage = page;
      
      // Update UI
      document.querySelectorAll('.content-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'bg-blue-50');
        if (btn.getAttribute('data-page') === page) {
          btn.classList.add('border-primary', 'bg-blue-50');
        }
      });
      
      document.getElementById('current-editing').textContent = page.charAt(0).toUpperCase() + page.slice(1);
      document.getElementById('content-editor').classList.remove('hidden');
      
      // Load content from API
      loadContent();
    }

    async function loadContent() {
      if (!currentPage) return;
      
      showToast('Loading content...', 'info');
      
      try {
        const response = await fetch(`api.php?endpoint=get-content&page=${currentPage}`);
        const data = await response.json();
        
        if (data.success) {
          currentContent = data.content;
          generateEditor(currentContent);
          showToast('Content loaded successfully!', 'success');
        } else {
          throw new Error(data.error || 'Failed to load content');
        }
      } catch (error) {
        showToast('Failed to load content: ' + error.message, 'error');
        console.error('Error loading content:', error);
      }
    }

    function generateEditor(content) {
      const editorContent = document.getElementById('editor-content');
      editorContent.innerHTML = '';
      
      if (!content) {
        editorContent.innerHTML = '<p class="text-gray-500">No content found. Create new content or check the data files.</p>';
        return;
      }
      
      // Generate form fields based on content structure
      Object.keys(content).forEach(sectionKey => {
        const section = content[sectionKey];
        const sectionDiv = createSectionEditor(sectionKey, section);
        editorContent.appendChild(sectionDiv);
      });
    }

    function createSectionEditor(key, data) {
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'mb-8 p-6 bg-gray-50 rounded-lg';
      
      const header = document.createElement('h3');
      header.className = 'text-lg font-semibold mb-4 text-gray-800 capitalize';
      header.textContent = key.replace('_', ' ');
      sectionDiv.appendChild(header);
      
      const fieldsDiv = document.createElement('div');
      fieldsDiv.className = 'space-y-4';
      
      generateFields(fieldsDiv, data, key);
      sectionDiv.appendChild(fieldsDiv);
      
      return sectionDiv;
    }

    function generateFields(container, data, parentKey) {
      if (typeof data === 'string') {
        createTextField(container, parentKey, data);
      } else if (typeof data === 'object' && !Array.isArray(data)) {
        Object.keys(data).forEach(fieldKey => {
          const fieldData = data[fieldKey];
          const fieldPath = `${parentKey}.${fieldKey}`;
          
          if (typeof fieldData === 'string') {
            createTextField(container, fieldKey, fieldData, fieldPath);
          } else if (Array.isArray(fieldData)) {
            createArrayEditor(container, fieldKey, fieldData, fieldPath);
          } else if (typeof fieldData === 'object') {
            const subContainer = document.createElement('div');
            subContainer.className = 'ml-4 p-4 bg-white rounded border';
            
            const subHeader = document.createElement('h4');
            subHeader.className = 'font-medium mb-3 text-gray-700 capitalize';
            subHeader.textContent = fieldKey.replace('_', ' ');
            subContainer.appendChild(subHeader);
            
            generateFields(subContainer, fieldData, fieldPath);
            container.appendChild(subContainer);
          }
        });
      } else if (Array.isArray(data)) {
        createArrayEditor(container, parentKey, data, parentKey);
      }
    }

    function createTextField(container, key, value, path = key) {
      const fieldDiv = document.createElement('div');
      fieldDiv.className = 'form-group';
      
      const label = document.createElement('label');
      label.className = 'block text-sm font-medium text-gray-700 mb-2 capitalize';
      label.textContent = key.replace('_', ' ');
      
      let input;
      if (value && value.length > 100) {
        input = document.createElement('textarea');
        input.className = 'w-full p-3 border border-gray-300 rounded-lg text-sm';
        input.rows = 3;
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full p-3 border border-gray-300 rounded-lg text-sm';
      }
      
      input.value = value || '';
      input.dataset.path = path;
      input.addEventListener('input', updateContent);
      
      fieldDiv.appendChild(label);
      fieldDiv.appendChild(input);
      container.appendChild(fieldDiv);
    }

    function createArrayEditor(container, key, array, path) {
      const arrayDiv = document.createElement('div');
      arrayDiv.className = 'array-editor p-4 bg-white rounded border';
      
      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-4';
      
      const title = document.createElement('h4');
      title.className = 'font-medium text-gray-700 capitalize';
      title.textContent = key.replace('_', ' ');
      
      const addBtn = document.createElement('button');
      addBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700';
      addBtn.innerHTML = '<i class="ri-add-line mr-1"></i>Add Item';
      addBtn.onclick = () => addArrayItem(arrayDiv, path, array);
      
      header.appendChild(title);
      header.appendChild(addBtn);
      arrayDiv.appendChild(header);
      
      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'array-items space-y-3';
      
      array.forEach((item, index) => {
        createArrayItemEditor(itemsContainer, item, `${path}[${index}]`, index);
      });
      
      arrayDiv.appendChild(itemsContainer);
      container.appendChild(arrayDiv);
    }

    function createArrayItemEditor(container, item, path, index) {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'array-item p-3 bg-gray-50 rounded border';
      
      const itemHeader = document.createElement('div');
      itemHeader.className = 'flex justify-between items-center mb-3';
      
      const itemTitle = document.createElement('h5');
      itemTitle.className = 'font-medium text-gray-600';
      itemTitle.textContent = `Item ${index + 1}`;
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700';
      deleteBtn.innerHTML = '<i class="ri-delete-bin-line"></i>';
      deleteBtn.onclick = () => removeArrayItem(itemDiv, path);
      
      itemHeader.appendChild(itemTitle);
      itemHeader.appendChild(deleteBtn);
      itemDiv.appendChild(itemHeader);
      
      if (typeof item === 'object') {
        Object.keys(item).forEach(key => {
          const fieldPath = `${path}.${key}`;
          createTextField(itemDiv, key, item[key], fieldPath);
        });
      } else {
        createTextField(itemDiv, 'value', item, path);
      }
      
      container.appendChild(itemDiv);
    }

    function updateContent() {
      // Update currentContent based on form inputs
      if (currentContent) {
        const formData = collectFormData();
        currentContent = formData;
        showToast('Content updated locally', 'info');
      }
    }

    function addArrayItem(arrayDiv, path, array) {
      // Create new item based on the first item structure or default
      let newItem;
      if (array.length > 0) {
        // Copy structure from first item
        newItem = JSON.parse(JSON.stringify(array[0]));
        // Clear values
        if (typeof newItem === 'object') {
          Object.keys(newItem).forEach(key => {
            if (typeof newItem[key] === 'string') {
              newItem[key] = '';
            }
          });
        } else {
          newItem = '';
        }
      } else {
        // Default structure for common array types
        if (path.includes('buttons') || path.includes('cards') || path.includes('items')) {
          newItem = {
            title: '',
            description: '',
            link: '#'
          };
        } else if (path.includes('images')) {
          newItem = {
            url: '',
            title: '',
            description: ''
          };
        } else {
          newItem = { value: '' };
        }
      }
      
      // Add to array
      const pathParts = path.split('.');
      let current = currentContent;
      
      for (let i = 0; i < pathParts.length - 1; i++) {
        current = current[pathParts[i]];
      }
      
      const arrayKey = pathParts[pathParts.length - 1];
      current[arrayKey].push(newItem);
      
      // Re-render the editor
      generateEditor(currentContent);
      showToast('Item added successfully!', 'success');
    }

    function removeArrayItem(itemDiv, path) {
      if (confirm('Are you sure you want to delete this item?')) {
        // Extract index from path (e.g., "hero.buttons[0]" -> 0)
        const matches = path.match(/\[(\d+)\]/);
        if (matches) {
          const index = parseInt(matches[1]);
          const basePath = path.replace(/\[\d+\]/, '');
          
          // Navigate to the array
          const pathParts = basePath.split('.');
          let current = currentContent;
          
          for (let i = 0; i < pathParts.length - 1; i++) {
            current = current[pathParts[i]];
          }
          
          const arrayKey = pathParts[pathParts.length - 1];
          
          // Remove item from array
          current[arrayKey].splice(index, 1);
          
          // Re-render the editor
          generateEditor(currentContent);
          showToast('Item deleted successfully!', 'success');
        }
      }
    }

    async function saveContent() {
      if (!currentPage || !currentContent) {
        showToast('No content to save', 'warning');
        return;
      }
      
      showToast('Saving content...', 'info');
      
      try {
        // Collect all form data and update currentContent
        const formData = collectFormData();
        
        const response = await fetch(`api.php?endpoint=save-content`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            page: currentPage,
            content: formData
          })
        });
        
        const data = await response.json();
        if (data.success) {
          // Signal frontend to force refresh content from API
          sessionStorage.setItem('forceContentRefresh', '1');
          showToast('Content saved successfully!', 'success');
        } else {
          throw new Error(data.error || 'Failed to save content');
        }
      } catch (error) {
        showToast('Failed to save content: ' + error.message, 'error');
        console.error('Error saving content:', error);
      }
    }

    function collectFormData() {
      // Collect all form inputs and reconstruct the JSON structure
      const inputs = document.querySelectorAll('[data-path]');
      const result = JSON.parse(JSON.stringify(currentContent)); // Deep clone
      
      inputs.forEach(input => {
        const path = input.dataset.path;
        let value = input.value;
        
        // Handle different input types
        if (input.type === 'checkbox') {
          value = input.checked;
        } else if (input.type === 'number') {
          value = parseFloat(value) || 0;
        }
        
        // Update the result object using the path
        setNestedValue(result, path, value);
      });
      
      return result;
    }

    function setNestedValue(obj, path, value) {
      const keys = path.split('.');
      let current = obj;
      
      for (let i = 0; i < keys.length - 1; i++) {
        const key = keys[i];
        if (!(key in current)) {
          current[key] = {};
        }
        current = current[key];
      }
      
      current[keys[keys.length - 1]] = value;
    }

    function previewChanges() {
      if (!currentPage) {
        showToast('No page selected', 'warning');
        return;
      }
      
      const pageUrl = `../${currentPage}.html`;
      window.open(pageUrl, '_blank');
      showToast('Opening preview...', 'info');
    }

    function showRawJSON() {
      if (!currentContent) return;
      
      document.getElementById('raw-json-editor').value = JSON.stringify(currentContent, null, 2);
      document.getElementById('raw-json-modal').classList.remove('hidden');
    }

    function closeRawJSON() {
      document.getElementById('raw-json-modal').classList.add('hidden');
    }

    function validateJSON() {
      const textarea = document.getElementById('raw-json-editor');
      try {
        JSON.parse(textarea.value);
        showToast('JSON is valid!', 'success');
      } catch (error) {
        showToast('Invalid JSON: ' + error.message, 'error');
      }
    }

    function applyRawJSON() {
      const textarea = document.getElementById('raw-json-editor');
      try {
        const newContent = JSON.parse(textarea.value);
        currentContent = newContent;
        generateEditor(currentContent);
        closeRawJSON();
        showToast('Changes applied!', 'success');
      } catch (error) {
        showToast('Invalid JSON: ' + error.message, 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast p-4 rounded-lg shadow-lg text-white ${getToastColor(type)}`;
      
      const icon = getToastIcon(type);
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="${icon} mr-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function getToastColor(type) {
      const colors = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
      };
      return colors[type] || colors.info;
    }

    function getToastIcon(type) {
      const icons = {
        'success': 'ri-check-line',
        'error': 'ri-error-warning-line',
        'warning': 'ri-alarm-warning-line',
        'info': 'ri-information-line'
      };
      return icons[type] || icons.info;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Visual Content Editor initialized');
    });
  </script>
</body>
</html>
